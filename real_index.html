<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title>CS171 Project</title>

  <!-- ADD Libraries-->
  <script src="libs/d3/d3.min.js" charset="utf-8"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
  <script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
  <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>

  <!--Stylesheets-->
  <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">

  <!-- Get some nice font-->
  <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>

    <!-- add own vis classes-->
    <script src = "js/tableview.js"></script>
    <script src = "js/mapview.js"></script>

    <!-- add own stylesheet-->
    <link rel="stylesheet" type="text/css" href="css/myStyle.css">

  </head>
  <body>
    <div class="container">
      <h1>CS171 Project</h1>

      <div class="row">
        <div class="col-md-8 col-sm-12">
         <p> The following visualization is a current prototype for our CS171 Project.</p>
        </div>

      </div>

      <div class="row">
      <div class="col-md-2">
        <button class="btn btn-sm btn-primary" id="fitInBtn"> <span class="glyphicon glyphicon-resize-horizontal"></span> reset zoom </button>
      </div>

      <div class="col-md-8">
        <b>Current Month: </b> <span id="monthInfo"></span>
        Time Update: <input type="range" name="yearmonth" min="23956" max="24182" step="1" value="0" id="slider" oninput = ";"> <br>
      </div>
    </div>

    <div class="row">
      <div class="col-md-7" id="mapVis">
      </div>
      <div class="col-md-5" id="tableVis">
      </div>
    </div>

    <div class="row">
      <div class="col-md-12" id="prioVis">
      </div>
    </div>
  </div>

<script>

$(function() { 
  //////////////////////////////
  ////// GLOBAL VARIABLES //////
  //////////////////////////////
  var mapData;
  var realData = [];
  var econData = {};
  var MyEventHandler = new Object();

  var dateFormatter = d3.time.format("%Y-%m-%d");

  var initVis = function(month) {
    // var MyEventHandler = new Object();

    // var map_vis = new MapVis(d3.select("#mapVis"), mapData, realData, econData, MyEventHandler)
    console.log(month)
    var table_vis = new TableVis(d3.select("#tableVis"), realData, month)

    $(MyEventHandler).bind("selectionChanged", function(event, month) {
      console.log("eventHandler")
      // document.getElementById('brushInfo').innerHTML = dateFormatter(selectionStart) + " -> " + dateFormatter(selectionEnd)
      // map_vis.onSelectionChange(month);
      table_vis.onSelectionChange(month);
    });
  }

  // call this function after both files are loaded -- error should be "null" if no error
  var dataLoaded = function (error, _realData, _econData) {
    if (!error) {
      // console.log(_mapData)
      array = []
      for (x in _realData) {
        array.push(_realData[x])
      }
      realData = array;
      // mapData = _mapData;
      econData = _econData;

      var month = "1996-04"
      initVis(month);
    }
    // svg.append("path")
    //   .datum(topojson.feature(_mapData, _mapData.objects.land))
    //   .attr("class", "land")
    //   .attr("d", path);

    // svg.append("path")
    //   .datum(topojson.mesh(_mapData, _mapData.objects.states, function(a, b) { return a !== b; }))
    //   .attr("class", "states")
    //   .attr("d", path);
    // start = d3.min(allData, function(d) { return d.time })
    // end = d3.max(allData, function(d) { return d.time })

    // document.getElementById('monthInfo').innerHTML = dateFormatter(month)
  }

  var startHere = function() {
    queue()
      // .defer(d3.json, "us.json")
      .defer(d3.json, "data/data.json")
      .defer(d3.json, "data/econdata.json")
      .await(dataLoaded)
  }

  startHere();

  d3.select("#slider").on("input", function(){
    var year = Math.floor(this.value / 12)
    var month = this.value % 12
    if (month == 0) month = 12

    var month_string = month < 10 ? "0" + month : String(month)
    var ans = year + "-" + month

    $(MyEventHandler).trigger("selectionChanged", year + "-" + month_string)
  })
}) // end entire function
</script>
</body>
</html>
