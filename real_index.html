<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title>CS171 Project</title>

  <!-- ADD Libraries-->
  <script src="libs/d3/d3.min.js" charset="utf-8"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
  <script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
  <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>

  <!--Stylesheets-->
  <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">

  <!-- Get some nice font-->
  <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>

    <!-- add own vis classes-->
    <script src = "js/ecview.js"></script>
    <script src = "js/mapview.js"></script>

    <!-- add own stylesheet-->
    <link rel="stylesheet" type="text/css" href="css/myStyle.css">

  </head>
  <body>
    <div class="container">
      <h1>CS171 Project</h1>

      <div class="row">
        <div class="col-md-8 col-sm-12">
         <p> The following visualization is a current prototype for our CS171 Project.</p>
        </div>

      </div>

      <div class="row">
      <div class="col-md-2">
        <button class="btn btn-sm btn-primary" id="fitInBtn"> <span class="glyphicon glyphicon-resize-horizontal"></span> reset zoom </button>
      </div>

      <div class="col-md-8">
        <b>Current Month: </b> <span id="monthInfo"></span>
        Time Update: <input type="range" name="yearmonth" min="23956" max="24182" step="1" value="0" id="slider" oninput = ";"> <br>
      </div>
    </div>

    <div class="row">
      <div class="col-md-8" id="mapVis">
      </div>
      <div class="col-md-4" id="tableVis">
      </div>
    </div>

    <div class="row">
      <div class="col-md-12" id="prioVis">
      </div>
    </div>
  </div>

<script>

$(function() { 
  //////////////////////////////
  ////// GLOBAL VARIABLES //////
  //////////////////////////////
  var realData = [];
  var econData = {};

  var start, end, month;
  var dateFormatter = d3.time.format("%Y-%m-%d");

  var initVis = function() {
    var MyEventHandler = new Object();

    var map_vis = new MapVis(d3.select("#mapVis"), realData, econData, MyEventHandler)
    var table_vis = new TableVis(d3.select("#tableVis"), realData, econData, month)

    $(MyEventHandler).bind("selectionChanged", function(event, selectionStart, selectionEnd) {
      // document.getElementById('brushInfo').innerHTML = dateFormatter(selectionStart) + " -> " + dateFormatter(selectionEnd)
      map_vis.onSelectionChange(selectionStart, selectionEnd);
      table_vis.onSelectionChange(selectionStart, selectionEnd);
    });
  }

  // call this function after both files are loaded -- error should be "null" if no error
  var dataLoaded = function (error, _realData, _econData) {
    if (!error) {
      realData = _Data.map(function(d) {
        var res = {
          time: dateFormatter.parse(d.day),
          count: parseInt(d["count(*)"])
        };

        res.prios = d3.range(0, 16).map(function(e) {
          return d["sum(p" + e + ")"];
        })

        res.ages = d3.range(0,100).map(function(e) {
          var count = 0
          for(i = 0; i < d.age.length; i++) {
            if(e == parseInt(d.age[i]["age"])) 
              count += parseInt(d.age[i]["count(*)"])
          }
          return count;
        })

        return res;
      })

      econData = _econData;
      initVis();
    }

    // start = d3.min(allData, function(d) { return d.time })
    // end = d3.max(allData, function(d) { return d.time })

    // document.getElementById('monthInfo').innerHTML = dateFormatter(start) + " -> " + dateFormatter(end)
  }

  var startHere = function() {
    queue()
      .defer(d3.json, "data/data.json")
      .defer(d3.json, "data/econdata.json")
      .await(dataLoaded)
  }

  startHere();

  d3.select("#slider").on("input", function(){
    console.log(this.value);
  })
}) // end entire function
</script>
</body>
</html>
