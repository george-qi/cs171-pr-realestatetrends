<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title>CS171 Project</title>

  <!-- ADD Libraries-->
  <script src="libs/d3/d3.min.js" charset="utf-8"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
  <script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
  <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>
  <script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>

  <!--Stylesheets-->
  <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">

  <!-- Get some nice font-->
  <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>

    <!-- add own vis classes-->
    <script src = "js/tableview.js"></script>
    <script src = "js/mapview.js"></script>
    <script src = "js/lineview.js"></script>
    <script src = "js/gdpview.js"></script>
    <script src = "js/histview.js"></script>

    <!-- add own stylesheet-->
    <link rel="stylesheet" type="text/css" href="css/myStyle.css">

  </head>
  <body>
    <div class="container">
      <h1>CS171 Project</h1>

      <div class="row">
        <div class="col-md-8 col-sm-12">
         <p> The following visualization is a current prototype for our CS171 Project.</p>
        </div>

      </div>

      <div class="row">
      <div class="col-md-4">
        Filter By:
        <label><input type="checkbox" name="All" value="All" title="All" onchange="update_filters(this.value, this.checked)"></input>All</label>
        <label><input type="checkbox" name="1br" value="1br" title="1br" onchange="update_filters(this.value, this.checked)"></input>1br</label>
        <label><input type="checkbox" name="2br" value="2br" title="2br" onchange="update_filters(this.value, this.checked)"></input>2br</label>
        <label><input type="checkbox" name="3br" value="3br" title="3br" onchange="update_filters(this.value, this.checked)"></input>3br</label>
        <label><input type="checkbox" name="4br" value="4br" title="4br" onchange="update_filters(this.value, this.checked)"></input>4br</label>
        <label><input type="checkbox" name="5br" value="5br" title="5br" onchange="update_filters(this.value, this.checked)"></input>5br</label>
      </div>

      <div class="col-md-8">
        <b>Current Month: </b> <span id="monthInfo"></span>
        Time Update: <input type="range" name="yearmonth" min="23956" max="24182" step="1" value="0" id="slider" oninput = ";"> <br>
      </div>
    </div>

    <div class="row">
      <div class="col-md-8" id="mapVis">
      </div>
      <div class="col-md-4" id="tableVis">
        <!-- placeholder -->
          <svg width="230" height="450" style="background-color: lightcoral">
            <text x="50" y="50">HERE should be Table</text>
          </svg>
      </div>
    </div>

    <div class="row">
      <div class="col-md-4" id="lineVis">
      </div>
      <div class="col-md-4" id="gdpVis">
      </div>
      <div class="col-md-4" id="histVis">
      </div>
    </div>
  </div>

<script>

// $(function() { 
//////////////////////////////
////// GLOBAL VARIABLES //////
//////////////////////////////
var mapData;
var realData;
var econData;
var stateGdpData;
var MyEventHandler = new Object();
var vars = {
  'month': "1996-04",
  'filter': [],
  'city': "New York",
  'state': "NY"
}

var dateFormatter = d3.time.format("%Y-%m-%d");

var initVis = function() {
  var map_vis = new MapVis(d3.select("#mapVis"), MyEventHandler, mapData, realData, vars)
  var table_vis = new TableVis(d3.select("#tableVis"), realData, vars)
  var line_vis = new LineVis(d3.select("#lineVis"), realData, vars)
  var gdp_vis = new GdpVis(d3.select("#gdpVis"), econData, stateGdpData, vars)
  var hist_vis = new HistVis(d3.select("#histVis"), realData, vars)

  // when you move the time scroller
  $(MyEventHandler).bind("selectionChanged", function(event) {
    // document.getElementById('monthInfo').innerHTML = dateFormatter(selectionStart) + " -> " + dateFormatter(selectionEnd)
    map_vis.onSelectionChange(vars);
    table_vis.onSelectionChange(vars);
    line_vis.onSelectionChange(vars);
    hist_vis.onSelectionChange(vars);
  });

  $(MyEventHandler).bind("tableFilter", function(event) {
    table_vis.onSelectionChange(vars);
    hist_vis.onSelectionChange(vars);
  })

  // when you hover over a node
  $(MyEventHandler).bind("nodeHover", function(event, city, state) {
    vars.city = city;
    vars.state = state;
    line_vis.onSelectionChange(vars);
    gdp_vis.onSelectionChange(vars);
  });
}

// call this function after both files are loaded -- error should be "null" if no error
var dataLoaded = function (error, _mapData, _realData, _econData, _stateGdpData) {
  if (!error) {
    // console.log(_mapData)
    array = []
    for (x in _realData) {
      array.push(_realData[x])
    }
    realData = array;
    mapData = _mapData;
    econData = _econData;
    stateGdpData = _stateGdpData;

    initVis(vars.month);
  }
}

var startHere = function() {
  queue()
    .defer(d3.json, "us.json")
    .defer(d3.json, "data/data.json")
    .defer(d3.json, "data/econdata.json")
    .defer(d3.json, "data/state_gdp.json")
    .await(dataLoaded)
}

startHere();

d3.select("#slider").on("input", function(){
  var year = Math.floor(this.value / 12)
  var month = this.value % 12
  if (month == 0) month = 12

  var month_string = month < 10 ? "0" + month : String(month)
  var ans = year + "-" + month

  vars.month = year + "-" + month_string
  $(MyEventHandler).trigger("selectionChanged")
})

// }) // end entire function

function update_filters(value, add) {
  if(add) {
    if(vars.filter.indexOf(value) < 0) {
      vars.filter.push(value)
    }
  } else {
    var index = vars.filter.indexOf(value)
    if(index > -1)
      vars.filter.splice(index, 1);
  }
  
  $(MyEventHandler).trigger("tableFilter")
}

</script>
</body>
</html>
